name: IPTV ç­›é€‰ä¸æ ¼å¼è½¬æ¢

on:
  schedule:
    # ç¨å¾®é”™å¼€æ•´ç‚¹ï¼Œé¿å… GitHub è°ƒåº¦é«˜å³°
    - cron: "15,45 * * * *" 
  workflow_dispatch: # ä¿ç•™è¿™ä¸ªï¼Œæ–¹ä¾¿æ‰‹åŠ¨ç‚¹å‡»æµ‹è¯•

jobs:
  filter-and-convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    concurrency:
      group: iptv-sync
      cancel-in-progress: true

    steps:
      - name: ğŸ“¥ Checkout ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ è®¾ç½® Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pip install requests

      - name: 1. è¿è¡Œé€Ÿåº¦ç­›é€‰ (æ ¸å¿ƒç”Ÿæˆ livezubo.txt)
        env:
          PYTHONUNBUFFERED: "1"
        run: python py/speed_filter.py

      - name: 2. æ‰§è¡Œåç»­è½¬æ¢ä¸å…¨é‡ç”Ÿæˆ
        run: |
          echo "å¼€å§‹è½¬æ¢ M3U..."
          python py/convert_to_m3u.py
          
          echo "å¼€å§‹å…¨é‡ç»„æ’­ç”Ÿæˆ..."
          python py/zubo.pgen_custom_list.py
          
          echo "å¼€å§‹ç”Ÿæˆæœ€ç»ˆå…¨é‡ M3U..."
          python py/convert_full_m3u.py
          
      - name: ğŸ“¤ æäº¤å¹¶æ¨é€æ›´æ–°
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          # å¿…é¡»æ˜¾å¼æ·»åŠ è¿™äº›æ–‡ä»¶
          git add py/blacklist.txt py/livezubo.txt py/live_full.txt test/*.m3u index.html || true
          
          # åªæœ‰åœ¨çœŸçš„æœ‰å˜åŒ–æ—¶æ‰ commit
          if git commit -m "è‡ªåŠ¨æ›´æ–°: $(date +'%Y-%m-%d %H:%M') [å«é»‘åå•åŒæ­¥]"; then
            git pull --rebase -X ours origin main
            git push origin main
          fi
