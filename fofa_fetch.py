import os
import re
import requests
import time
import concurrent.futures
import subprocess
from datetime import datetime, timezone, timedelta

# ===============================
# é…ç½®åŒº
FOFA_URLS = {
    "https://fofa.info/result?qbase64=InVkcHh5IiAmJiBjb3VudHJ5PSJDTiI%3D": "ip.txt",
}
HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
}

COUNTER_FILE = "è®¡æ•°.txt"
IP_DIR = "ip"
RTP_DIR = "rtp"
ZUBO_FILE = "zubo.txt"
IPTV_FILE = "IPTV.txt"

# ===============================
# åˆ†ç±»ä¸æ˜ å°„é…ç½®
CHANNEL_CATEGORIES = {
"å¤®è§†é¢‘é“":[
"CCTV-1ç»¼åˆ","CCTV-2è´¢ç»","CCTV-3ç»¼è‰º","CCTV-4ä¸­æ–‡å›½é™…","CCTV-5ä½“è‚²","CCTV-5+ä½“è‚²èµ›äº‹","CCTV-6ç”µå½±","CCTV-7å›½é˜²å†›äº‹","CCTV-8ç”µè§†å‰§","CCTV-9çºªå½•","CCTV-10ç§‘æ•™","CCTV-11æˆæ›²","CCTV-12ç¤¾ä¼šä¸æ³•","CCTV-13æ–°é—»","CCTV-14å°‘å„¿","CCTV-15éŸ³ä¹","CCTV-16å¥¥æ—åŒ¹å…‹","CCTV-16å¥¥æ—åŒ¹å…‹4K","CCTV-17å†œä¸šå†œæ‘","CCTV-4æ¬§æ´²","CCTV-4ç¾æ´²","CCTV-4K","CCTV-8K","ä¸­å¤®æ–°å½±-ä¸­å­¦ç”Ÿ","ä¸­å¤®æ–°å½±-è€æ•…äº‹","ä¸­å¤®æ–°å½±-å‘ç°ä¹‹æ—…","CGTN","CGTN-çºªå½•","CGTN-æ³•è¯­","CGTN-ä¿„è¯­","CGTN-è¥¿ç­ç‰™è¯­","CGTN-é˜¿æ‹‰ä¼¯è¯­","ä¸­å›½æ•™è‚²1å°","ä¸­å›½æ•™è‚²2å°","ä¸­å›½æ•™è‚²4å°","æ—©æœŸæ•™è‚²"
],
"ä»˜è´¹é¢‘é“":[
"é£äº‘å‰§åœº","æ€€æ—§å‰§åœº","ç¬¬ä¸€å‰§åœº","é£äº‘è¶³çƒ","å¤®è§†å°çƒ","é«˜å°”å¤«Â·ç½‘çƒ","é£äº‘éŸ³ä¹","å¤®è§†æ–‡åŒ–ç²¾å“","å«ç”Ÿå¥åº·","ç”µè§†æŒ‡å—","å…µå™¨ç§‘æŠ€","å¥³æ€§æ—¶å°š","ä¸–ç•Œåœ°ç†","CHCå®¶åº­å½±é™¢","CHCåŠ¨ä½œç”µå½±","CHCå½±è¿·ç”µå½±"
],
"å«è§†é¢‘é“":[
"å±±ä¸œå«è§†", "æ¹–å—å«è§†", "æµ™æ±Ÿå«è§†", "æ±Ÿè‹å«è§†", "ä¸œæ–¹å«è§†", "æ·±åœ³å«è§†", "åŒ—äº¬å«è§†", "å¹¿ä¸œå«è§†", "å¹¿è¥¿å«è§†", "ä¸œå—å«è§†", "æµ·å—å«è§†","æ²³åŒ—å«è§†", "æ²³å—å«è§†", "æ¹–åŒ—å«è§†", "æ±Ÿè¥¿å«è§†", "å››å·å«è§†", "é‡åº†å«è§†", "è´µå·å«è§†", "äº‘å—å«è§†", "å¤©æ´¥å«è§†", "å®‰å¾½å«è§†","è¾½å®å«è§†", "é»‘é¾™æ±Ÿå«è§†", "å‰æ—å«è§†", "å†…è’™å¤å«è§†", "å®å¤å«è§†", "å±±è¥¿å«è§†", "é™•è¥¿å«è§†", "ç”˜è‚ƒå«è§†", "é’æµ·å«è§†","æ–°ç–†å«è§†", "è¥¿è—å«è§†", "ä¸‰æ²™å«è§†", "å…µå›¢å«è§†", "å»¶è¾¹å«è§†", "å®‰å¤šå«è§†", "åº·å·´å«è§†", "å†œæ—å«è§†", "å±±ä¸œæ•™è‚²å«è§†","å¤§æ¹¾åŒºå«è§†","æµ·å³¡å«è§†","è¥¿è—å«è§†è—è¯­","å®‰å¤šå«è§†è—è¯­","åº·å·´å«è§†è—è¯­","å†…è’™å¤å«è§†è’™è¯­"
],
"é«˜æ¸…é¢‘é“":[
"åŒ—äº¬å«è§†4K","å¹¿ä¸œå«è§†4K","æ·±åœ³å«è§†4K","å±±ä¸œå«è§†4K","æ¹–å—å«è§†4K","æµ™æ±Ÿå«è§†4K","æ±Ÿè‹å«è§†4K","ä¸œæ–¹å«è§†4K","å››å·å«è§†4K"
],
"å›½é™…é¢‘é“":[
"å‡¤å‡°å«è§†","å‡¤å‡°èµ„è®¯","å‡¤å‡°é¦™æ¸¯","å‡¤å‡°ç”µå½±","æ˜Ÿç©ºå«è§†","Channel[V]"
],
"æ•°å­—é¢‘é“":[
"é‡‘é¹°å¡é€š","å¿«ä¹å‚é’“","èŒ¶é¢‘é“","æ±‚ç´¢çºªå½•","ä¸­å›½å¤©æ°”","å¤©å…ƒå›´æ£‹","ç›å½©ç«æŠ€","ç›å½©ç¯®çƒ","ç›å½©é’å°‘å¹´","ç›å½©å¹¿åœºèˆ","åŒ—äº¬çºªå®ç§‘æ•™","é‡æ¸©ç»å…¸ç”µå½±","å°‘å„¿åŠ¨ç”»","å¡é…·å°‘å„¿","åŠ¨æ¼«ç§€åœº","å˜‰ä½³å¡é€š","ä¼˜æ¼«å¡é€š","å“ˆå“ˆç‚«åŠ¨","æ–°åŠ¨æ¼«","ä¼˜ä¼˜å®è´","é‡‘è‰²å­¦å ‚","ä¹æ¸¸","æ¸¸æˆé£äº‘","éƒ½å¸‚å‰§åœº","æ³•æ²»å¤©åœ°","æ¢¨å›­é¢‘é“","æ­¦æœ¯ä¸–ç•Œ","æ–‡ç‰©å®åº“","ç²¾å½©å½±è§†","ç”Ÿæ´»æ—¶å°š","ä¸­å›½äº¤é€š","æ±½æ‘©é¢‘é“","é­…åŠ›è¶³çƒ","å…ˆé”‹ä¹’ç¾½","å››æµ·é’“é±¼","ä¸­åç‰¹äº§","ç¯çƒæ—…æ¸¸","ä¸œæ–¹è´¢ç»","ä¹¦ç”»é¢‘é“","ç”Ÿæ€ç¯å¢ƒ","å®¶åº­ç†è´¢","è´¢å¯Œå¤©ä¸‹","è½¦è¿·é¢‘é“","æµ·æ´‹é¢‘é“","å†›äº‹","è§£å¯†","åœ°ç†","å¯¼è§†","è¶³çƒ","æˆæ›²","æ¥é’“é±¼å§","éº»è¾£ä½“è‚²","ç»šå½±4K","ä¹é¾„å­¦å ‚","4Kä¹äº«è¶…æ¸…","ç²¾å½©æ¨è","çˆ±ä¸Š4K","ç”µç«æ¯”èµ›","ä¸­å›½å¤©æ°”","IPTV3+","IPTV5+","IPTV5+HD","IPTV6+","IPTV8+","IPTVæ”¶è§†æŒ‡å—","IPTVç»å…¸ç”µå½±","IPTVçƒ­æ’­å‰§åœº","IPTVé­…åŠ›æ—¶å°š","IPTVç›¸å£°å°å“","IPTVè°æˆ˜å‰§åœº","IPTVæ³•æ²»","IPTVé‡å¤–","IPTVéŸ³ä¹ç°åœº","IPTVå°‘å„¿åŠ¨ç”»","IPTVåŠ¨ä½œå½±é™¢","IPTVå–œå‰§å½±é™¢","IPTVå®¶åº­å½±é™¢","IPTVæ­¦ä¾ å‰§åœº","IPTVå†›æ—…å‰§åœº","IPTVåŸå¸‚å‰§åœº","IPTVå¤è£…å‰§åœº","IPTVå¥½å­¦ç”Ÿ","IPTVå›½å­¦","IPTVæˆæ›²","IPTVå¢¨å®","IPTVæ—©æ•™","IPTVç¾äºº","IPTVåŠ¨ç”»","IPTVåœ°ç†","IPTVè§£å¯†","IPTVå†›äº‹","IPTVè¶³çƒ","IPTVæ­¦æœ¯","IPTVç²¾é€‰","IPTVçˆ±ç”Ÿæ´»","IPTVå°çƒ","IPTVé«˜ç½‘"
],
"å±±ä¸œé¢‘é“":[
"å±±ä¸œé½é²","å±±ä¸œä½“è‚²","å±±ä¸œå†œç§‘","å±±ä¸œæ–°é—»","å±±ä¸œå°‘å„¿","å±±ä¸œæ–‡æ—…","å±±ä¸œç»¼è‰º","å±±ä¸œç”Ÿæ´»","å±±ä¸œæ•™è‚²å«è§†","å±±ä¸œå±…å®¶è´­ç‰©","QTV-1","QTV-2","QTV-3","QTV-4","QTV-5","å´‚å±±ç»¼åˆ","é»„å²›ç»¼åˆ","é»„å²›ç”Ÿæ´»","èƒ¶å·ç»¼åˆ","å¹³åº¦æ–°é—»","è±è¥¿ç»¼åˆ","æµå—æ–°é—»","æµå—æ–°é—»","æµå—æ•™è‚²","æµå—éƒ½å¸‚","æµå—ç”Ÿæ´»","æµå—æ–‡æ—…æ•™è‚²","æµå—å¨±ä¹","æµå—å°‘å„¿","æµå—é²ä¸­","å†åŸç»¼åˆ","é•¿æ¸…æ–°é—»","æµé˜³ç»¼åˆ","å¹³é˜´ç»¼åˆ","å•†æ²³ç»¼åˆ","æ·„åšæ–°é—»","æ·„åšå½±è§†","æ·„åšæ–‡æ—…","æ·„åšæ°‘ç”Ÿ","å¼ åº—ç»¼åˆ","æ·„å·æ–°é—»","å‘¨æ‘æ–°é—»","æ¡“å°ç»¼åˆ","é«˜é’ç»¼åˆ","æ²‚æºæ–°é—»","ä¸œè¥ç»¼åˆ","ä¸œè¥å…¬å…±","å¹¿é¥¶æ–°é—»","çƒŸå°æ–°é—»","çƒŸå°å…¬å…±","çƒŸå°ç»æµç§‘æ•™","çƒŸå°å½±è§†","ç‰Ÿå¹³æ–°é—»","ç‰Ÿå¹³ç”Ÿæ´»","è“¬è±æ–°é—»","é¾™å£ç»¼åˆ","æ‹›è¿œç»¼åˆ","æ –éœç»¼åˆ","æµ·é˜³ç»¼åˆ","æµ·é˜³ç»¼è‰º","é•¿å²›ç»¼åˆ","æ½åŠæ–°é—»","æ½åŠç»æµç”Ÿæ´»","æ½åŠå½±è§†ç»¼è‰º","æ½åŠç§‘æ•™æ–‡æ—…","æ½åŠé«˜æ–°åŒº","é’å·æ–°é—»","é’å·æ–‡æ—…","è¯¸åŸæ–°é—»","å¯¿å…‰æ–°é—»","å¯¿å…‰è”¬èœ","å®‰ä¸˜æ–°é—»","é«˜å¯†ç»¼åˆ","æ˜Œé‚‘ç»¼åˆ","æ˜Œä¹ç»¼åˆ","ä¸´æœç»¼åˆ","æµå®ç»¼åˆ","æµå®ç”Ÿæ´»","æµå®å…¬å…±","æµå®é«˜æ–°","ä»»åŸ-1","ä»»åŸ-2","å…–å·æ–°é—»","æ›²é˜œæ–°é—»ç»¼åˆ","é‚¹åŸç»¼åˆ","é±¼å°æ–°é—»","é±¼å°ç”Ÿæ´»","å˜‰ç¥¥ç»¼åˆ","æ¢å±±ç»¼åˆ","æ³°å±±ç”µè§†","è‚¥åŸç»¼åˆ","å²±å²³æœ‰çº¿","æ–°æ³°ç»¼åˆ","æ–°æ³°ä¹¡æ‘","å®é˜³ç»¼åˆ","å®é˜³å½±è§†","ä¸œå¹³æ–°é—»","å¨æµ·æ–°é—»","å¨æµ·éƒ½å¸‚ç”Ÿæ´»","æ–‡ç™»ç»¼åˆ","è£æˆç»¼åˆ","ä¹³å±±ç»¼åˆ","æ—¥ç…§æ–°é—»","æ—¥ç…§ç§‘æ•™","æ—¥ç…§å…¬å…±","è’å¿ç»¼åˆ","å²šå±±ç»¼åˆ","æ²³ä¸œç»¼åˆ","æ²‚æ°´ç»¼åˆ","æ²‚æ°´ç”Ÿæ´»","å…°é™µç»¼åˆ","å…°é™µå…¬å…±","äº”è²æ–°é—»","è’™é˜´ç»¼åˆ","ä¸´æ²­ç»¼åˆ","è’å—ç»¼åˆ","å¾·å·æ–°é—»ç»¼åˆ","å¾·å·ç»æµç”Ÿæ´»","é™µåŸæ–°é—»","ç¦¹åŸç»¼åˆ","ç¦¹åŸç»¼è‰º","å®æ´¥ç»¼åˆ","é½æ²³ç»¼åˆ","æ­¦åŸæ–°é—»","æ­¦åŸç»¼è‰ºå½±è§†","å¹³åŸæ–°é—»","å¤æ´¥æ–°é—»","å¤æ´¥å…¬å…±","ä¸´é‚‘ç»¼åˆ","èŠåŸç»¼åˆ","èŠåŸæ°‘ç”Ÿ","èŒŒå¹³æ–°é—»","ä¸´æ¸…ç»¼åˆ","è˜å¿ç»¼åˆ","å† å¿ç»¼åˆ","ä¸œé˜¿ç»¼åˆ","æ»¨å·ç»¼åˆ","æ»¨å·æ°‘ç”Ÿ","æ²¾åŒ–ç»¼åˆ","é‚¹å¹³æ–°é—»","æƒ æ°‘ç»¼åˆ","é˜³ä¿¡æ–°é—»","æ— æ££æ–°é—»","èæ³½æ–°é—»","èæ³½ç”Ÿæ´»","å®šé™¶TV-1","å•å¿ç»¼åˆ","é„„åŸæ–°é—»","éƒ“åŸç»¼åˆ","å·¨é‡æ–°é—»","ä¸œæ˜æ–°é—»","æ±¶ä¸Šç»¼åˆ","å±±ä¸œç»æµå¹¿æ’­","å±±ä¸œäº¤é€šå¹¿æ’­"
],
"åŒ—äº¬é¢‘é“":[
"åŒ—äº¬IPTV4Kè¶…æ¸…","åŒ—äº¬IPTVæ·˜ç”µå½±","åŒ—äº¬IPTVæ·˜å‰§åœº","åŒ—äº¬IPTVæ·˜ç²¾å½©","åŒ—äº¬IPTVæ·˜å¨±ä¹","åŒ—äº¬IPTVæ·˜Baby","åŒ—äº¬IPTVèŒå® TV","åŒ—äº¬IPTVé‡æ¸©ç»å…¸","åŒ—äº¬çºªå®ç§‘æ•™","åŒ—äº¬å¡é…·å°‘å„¿","åŒ—äº¬ä½“è‚²ä¼‘é—²","åŒ—äº¬æ–‡è‰º","åŒ—äº¬å½±è§†","åŒ—äº¬è´¢ç»","åŒ—äº¬ç”Ÿæ´»","åŒ—äº¬æ–°é—»","åŒ—äº¬é’å¹´","åŒ—äº¬å›½é™…","æœé˜³èåª’","é€šå·åŒº","é—¨å¤´æ²ŸåŒº","æˆ¿å±±","å¯†äº‘","å»¶åº†åŒº"
],
"å¹¿ä¸œé¢‘é“":[
"å¹¿ä¸œä½“è‚²","å¹¿ä¸œç æ±Ÿ","å¹¿ä¸œå½±è§†","å¹¿ä¸œæ°‘ç”Ÿ","å¹¿ä¸œç°ä»£æ•™è‚²","å¹¿ä¸œç»æµç§‘æ•™","å¹¿ä¸œæ–°é—»","å²­å—æˆæ›²","å¹¿ä¸œå˜‰ä½³å¡é€š","å¹¿ä¸œå°‘å„¿","å¹¿ä¸œç»¼è‰º4K","å¹¿å·ç»¼åˆ","å¹¿å·æ–°é—»","å¹¿å·å½±è§†","å¹¿å·æ³•æ²»","å—å›½éƒ½å¸‚4K","æ·±åœ³éƒ½å¸‚","æ·±åœ³ç”µè§†å‰§","æ·±åœ³é¾™å²—","æ·±åœ³è´¢ç»ç”Ÿæ´»","æ·±åœ³ä½“è‚²å¥åº·","æ·±åœ³å°‘å„¿","æ·±åœ³ä¼—åˆ›TV","å®å®‰é¢‘é“","ä½›å±±ç»¼åˆ","ä½›å±±å½±è§†","ä½›å±±å…¬å…±","ä¸œèç»¼åˆ","ä¸œèèµ„è®¯","ä½›å±±é¡ºå¾·","ä½›å±±å—æµ·","ç æµ·ç»¼åˆ","æ±•å°¾ç»¼åˆ","æ±•å°¾æ–‡åŒ–ç”Ÿæ´»","éŸ¶å…³ç»¼åˆ","æ¹›æ±Ÿç»¼åˆ","æ¹›æ±Ÿå…¬å…±","æ±Ÿé—¨ç»¼åˆ","æ±Ÿé—¨ä¾¨ä¹¡ç”Ÿæ´»","èŒ‚åç»¼åˆ","èŒ‚åæ–‡åŒ–ç”Ÿæ´»","æ­é˜³ç»¼åˆ","æ­é˜³ç”Ÿæ´»","äº‘æµ®ç»¼åˆ","äº‘æµ®æ–‡æ—…","æ±•å¤´ç»¼åˆ","æ±•å¤´ç»æµç”Ÿæ´»","æ±•å¤´ç»æµ","æ±•å¤´æ–‡æ—…ä½“è‚²","æ±•å¤´ä½“è‚²","æƒ å·-1","æƒ å·-2","æ½®å·ç»¼åˆ","æ½®å·æ°‘ç”Ÿ","æ¢…å·ç»¼åˆ","æ¢…å·å®¢å®¶ç”Ÿæ´»","ä¸­å±±ç»¼åˆ","ä¸­å±±æ–‡åŒ–","é˜³æ±Ÿ-1","é˜³æ±Ÿ-2","è‚‡åº†ç»¼åˆ","è‚‡åº†ç”Ÿæ´»","æ¸…è¿œç»¼åˆ","æ¸…è¿œç”Ÿæ´»","æ²³æºç»¼åˆ","æ²³æºå…¬å…±"
],
"ä¸Šæµ·é¢‘é“":[
"ä¸Šæµ·æ–°é—»ç»¼åˆ","äº”æ˜Ÿä½“è‚²","ç¬¬ä¸€è´¢ç»","ä¸Šæµ·éƒ½å¸‚","ä¸œæ–¹å½±è§†","ä¸œæ–¹è´¢ç»","ä¸Šæµ·æ•™è‚²","æ¬¢ç¬‘å‰§åœº4K","ä¸œæ–¹è´­ç‰©1","ä¸œæ–¹è´­ç‰©2","ä¸Šæµ·å¥åº·å…»ç”Ÿ","BesTV4KåŠ¨ç”»","BesTV4Kç”µå½±","BesTV4Kçºªå½•","BesTV4KåŠ¨ç”»","BesTVç”µå½±ä»‹ç»","BesTVäººæ–‡","BesTV4Kç”µå½±","BesTVç›´æ’­1","BesTVç›´æ’­2","BesTVç›´æ’­3","BesTV4Kç”µå½±","BesTVç›´æ’­4","BesTVç›´æ’­5","BesTVç›´æ’­6","BesTVç›´æ’­7","BesTVç›´æ’­8","BesTVç›´æ’­9","BesTVç”µå½±ä»‹ç»","BesTVç”µå½±ä»‹ç»","BesTVç›´æ’­4","BesTVç›´æ’­10","BesTV4Kç”µå½±","BesTV4Kçºªå½•","BesTV4KåŠ¨ç”»"
],
"æ²³åŒ—é¢‘é“":[
"æ²³åŒ—ç»æµç”Ÿæ´»","æ²³åŒ—éƒ½å¸‚","æ²³åŒ—å½±è§†å‰§","æ²³åŒ—å°‘å„¿ç§‘æ•™","æ²³åŒ—æ–‡æ—…å…¬å…±","æ²³åŒ—å†œæ°‘","ç›å½©æ²³åŒ—","æ²³åŒ—æ‚æŠ€","æ²³åŒ—ä¸‰ä½³è´­ç‰©","çŸ³å®¶åº„æ–°é—»ç»¼åˆ","çŸ³å®¶åº„æ–‡åŒ–å¨±ä¹","çŸ³å®¶åº„åŸå¸‚æœåŠ¡","æ‰¿å¾·æ–°é—»ç»¼åˆ","æ‰¿å¾·æ—…æ¸¸æ–‡åŒ–","ç§¦çš‡å²›æ–°é—»ç»¼åˆ","ç§¦çš‡å²›å…¬å…±","ç§¦çš‡å²›å½±è§†","å”å±±æ–°é—»ç»¼åˆ","å”å±±ç”Ÿæ´»æœåŠ¡","å”å±±å½±è§†","å”å±±å…¬å…±","å»ŠåŠæ–°é—»ç»¼åˆ","å»ŠåŠç”Ÿæ´»","ä¿å®šæ–°é—»ç»¼åˆ","ä¿å®šå…¬å…±","ä¿å®šç”Ÿæ´»å¥åº·","è¡¡æ°´æ–°é—»ç»¼åˆ","è¡¡æ°´ç»æµç§‘æ•™","é‚¢å°ç»¼åˆ","é‚¢å°åŸå¸‚ç”Ÿæ´»","é‚¯éƒ¸æ–°é—»ç»¼åˆ","é‚¯éƒ¸å…¬å…±","é‚¯éƒ¸ç§‘æŠ€æ•™è‚²","é«˜é‚‘èåª’","äº•é™‰çŸ¿åŒºç”µè§†å°","æ·±æ³½ç»¼åˆ","èµµå¿ç»¼åˆ","æ™‹å·ç»¼åˆ","äº•é™‰ç»¼åˆ","å¹³æ³‰ç»¼åˆ","å…´éš†ç»¼åˆ","éš†åŒ–ç»¼åˆ","å´‡ç¤¼ç”µè§†å°","åº·ä¿ç»¼åˆ","éµåŒ–ç»¼åˆ","ä¸‰æ²³ç»¼åˆ","æ°¸æ¸…ç»¼åˆ","æˆå®‰ç»¼åˆ","é­å¿ç»¼åˆæ–°é—»","æ»¦å—ç»¼åˆ","ç‰ç”°ç»¼åˆ","å´æ¡¥ç»¼åˆ","é˜œå¹³ç”µè§†å°","æ¶æ°´ç»¼åˆ","é»„éª…ç”µè§†å°","å®šå·æ–°é—»ç»¼åˆ","é›„å¿ç”µè§†å°","æ¶æºç»¼åˆ","é«˜ç¢‘åº—ç»¼åˆ","æ¶¿å·ç»¼åˆ","å”å¿ç»¼åˆ","æ›²é˜³ç»¼åˆ","æŸä¹¡ç»¼åˆ","å¾æ°´ç”µè§†å°","æ™¯å¿ç»¼åˆ","é¥¶é˜³ç”µè§†å°","æ·±å·æ–°é—»ç»¼åˆ","æ¶‰å¿ç»¼åˆ","é¸¡æ³½æ–°é—»ç»¼åˆ","æ­¦å®‰æ–°é—»ç»¼åˆ","æ£å¼ºç»¼åˆ","æ¸…æ²³ç”µè§†å°","å¤§å‚èåª’ä½“ä¸­å¿ƒ","é¡ºå¹³ç”µè§†","èµ¤åŸç”µè§†","é‚¯å±±ç”µè§†","ä»»å¿ç”µè§†","åŒæ»¦ç”µè§†","æ»¦å¹³ç”µè§†","èµçš‡ç”µè§†","æ ¾åŸç”µè§†","å¼ å®¶å£æ–°é—»ç»¼åˆ","å¼ å®¶å£å…¬å…±","æ²§å·æ–°é—»ç»¼åˆ","æ²§å·å…¬å…±","æ²§å·å½±è§†å¨±ä¹","æ˜Œé»ç”µè§†","æŠšå®ç”µè§†","å¢é¾™ç”µè§†","ä¸°å—ç”µè§†","è¿è¥¿ç”µè§†","æ»¦å·ç”µè§†","é¦™æ²³ç”µè§†","å¤§åŸç”µè§†","å›ºå®‰ç”µè§†","éœ¸å·ç”µè§†","å­Ÿæ‘ç”µè§†","ä¸œå…‰ç”µè§†","é’å¿ç”µè§†","ç›å±±ç”µè§†","å—çš®ç”µè§†","è‚ƒå®ç”µè§†","ä¸°å®ç”µè§†","å®šå…´ç”µè§†","æ»¡åŸç”µè§†","æœ›éƒ½ç”µè§†","é«˜é˜³ç”µè§†","å®‰æ–°ç”µè§†","å®¹åŸç”µè§†","æ¶¿é¹¿ç”µè§†","å¤§åç”µè§†","å†€å·ç”µè§†","å®‰å¹³ç”µè§†","é˜œåŸç”µè§†","æ•…åŸç”µè§†","å¹¿å®—ç”µè§†","å®æ™‹ç”µè§†","å¹³ä¹¡ç”µè§†","éš†å°§ç”µè§†","å¹¿å¹³ç”µè§†","å—å’Œç”µè§†","ä¸´æ¼³ç”µè§†å°","å†…ä¸˜ç”µè§†å°","è¿å®‰ç”µè§†","é¦†é™¶ç”µè§†","ä¹äº­ç”µè§†","æ²™æ²³ç”µè§†","å—å®«ç”µè§†","ä¸°æ¶¦ç”µè§†","æ²³åŒ—ä¸´æ—¶ç›´æ’­é¢‘é“ 2","æ²³åŒ—ä¸´æ—¶ç›´æ’­é¢‘é“ 3","æ²³åŒ—ç¾½æ¯›çƒä¸“åŒº","æ²³åŒ—ä¸­å¼å…«çƒå›½é™…å…¬å¼€èµ›","æ²³åŒ—ä¹å±ç›´æ’­"
],
"å››å·é¢‘é“":[
"å››å·æ–‡åŒ–æ—…æ¸¸","å››å·ç»æµ","å››å·æ–°é—»","å››å·å½±è§†æ–‡è‰º","å››å·å³¨çœ‰ç”µå½±","å››å·æ˜Ÿç©ºè´­ç‰©","å››å·å¦‡å¥³å„¿ç«¥","å››å·ç§‘æ•™","å››å·ä¹¡æ‘","ç†ŠçŒ«æ–°é—»","ç†ŠçŒ«ä½“å¨±","ç†ŠçŒ«å°‘å„¿","ç†ŠçŒ«å½±é™¢","äº‘çœ‹ç†ŠçŒ«","é‡‘ç†ŠçŒ«å¡é€š","è“‰åŸå…ˆé”‹","æˆéƒ½æ–°é—»ç»¼åˆ","æˆéƒ½ç»æµèµ„è®¯æœåŠ¡","æˆéƒ½éƒ½å¸‚ç§‘æ•™","æˆéƒ½å½±è§†æ–‡è‰º","æˆéƒ½å…¬å…±","æˆéƒ½å°‘å„¿","æˆéƒ½æ¯æ—¥è´­ç‰©","ç†ŠçŒ«çˆ±ç”Ÿæ´»","iæˆéƒ½","å¤§çˆ±å››å·","å¤§çˆ±æ—…æ¸¸","å¤§çˆ±ç”Ÿæ´»","å¤§çˆ±æ—¶å°š","çº¢åŸæ—¥å¹²ä¹”","çº¢åŸæœˆäº®æ¹¾","å››å·ç”µä¿¡å¯¼è§†3","é›…å…‹éŸ³ä¹èŠ‚ç›´æ’­","é›…å…‹éŸ³ä¹èŠ‚å®£ä¼ ","äº‘æ¼”è‰ºå®£ä¼ ","åè¥¿è¯åˆ¸","å››å·çˆ±ä¸Š4K","å››å·4Kè§†ç•Œ","å››å·ç²¾å½©å¯¼è§†","å››å·å®¶æ”¿é¢‘é“","å››å·ç»å…¸ç”µå½±","å››å·åè¯­å½±é™¢","å››å·æ˜Ÿå…‰é™¢çº¿","å››å·å…¨çƒå¤§ç‰‡","å››å·çƒ­æ’­å‰§åœº","å››å·çƒ­é—¨å‰§åœº","å››å·å¥åº·å…»ç”Ÿ","å››å·è°æˆ˜å‰§åœº","å››å·å®å®åŠ¨ç”»","å››å·é’æ˜¥åŠ¨æ¼«","å››å·çƒ­é—¨ç»¼è‰º","å››å·éŸ³ä¹ç°åœº","å››å·æˆæ›²ç²¾é€‰","å››å·é­…åŠ›æ—¶å°š","å››å·ç™¾å˜è¯¾å ‚","å››å·ç”µç«å¤©å ‚","å››å·çº¢è‰²å½±é™¢","å››å·ç»å…¸å‰§åœº","å››å·çˆ±ä½“è‚²","å››å·çˆ±ç”Ÿæ´»","å››å·çˆ±æµªæ¼«","å››å·çˆ±å–œå‰§","å››å·çˆ±å¥‡è°ˆ","å››å·çˆ±ç§‘å¹»","å››å·çˆ±é™¢çº¿","å››å·çˆ±è°æˆ˜","å››å·çˆ±å†å²","å››å·çˆ±æ‚¬ç–‘","å››å·çˆ±æ—…è¡Œ","å››å·çˆ±å¹¼æ•™","å››å·çˆ±ç©å…·","å››å·çˆ±åŠ¨æ¼«","å››å·çˆ±èµ›è½¦","å››å·çˆ±å® ç‰©","å››å·å°‘å„¿å¤©åœ°","å››å·æ”¶è§†æŒ‡å—","å››å·ä¸­å›½ä½“è‚²1","å››å·ä¸­å›½ä½“è‚²2","å››å·ä¸­å›½ä½“è‚²3","å››å·ç›´æ’­å®¤1","å››å·ç›´æ’­å®¤2","å››å·ç›´æ’­å®¤3","å››å·ç›´æ’­å®¤4","å››å·ç›´æ’­å®¤5","å››å·ç›´æ’­å®¤6","å››å·ç›´æ’­å®¤7","å››å·ç›´æ’­å®¤8"
],
"æµ™æ±Ÿé¢‘é“":[
"æµ™æ±Ÿé’±æ±Ÿéƒ½å¸‚","æµ™æ±Ÿç»æµç”Ÿæ´»","æµ™æ±Ÿæ•™ç§‘å½±è§†","æµ™æ±Ÿæ°‘ç”Ÿä¼‘é—²","æµ™æ±Ÿå…¬å…±æ–°é—»","æµ™æ±Ÿå°‘å„¿","ä¹‹æ±Ÿçºªå½•","æ­å·ç»¼åˆ","æ­å·è¥¿æ¹–æ˜ç ","æ­å·ç”Ÿæ´»","æ­å·å½±è§†","æ­å·é’å°‘ä½“è‚²","æ­å·å¯¼è§†","ä¸´å¹³æ–°é—»","ä½™æ­æ–°é—»","å®æ³¢TV1","å®æ³¢TV2","å®æ³¢TV3","å®æ³¢TV4","æ¸©å·æ–°é—»ç»¼åˆ","ç»å…´æ–°é—»ç»¼åˆ","æ¹–å·æ–°é—»ç»¼åˆ","é‡‘åæ–°é—»","ä¸½æ°´æ–°é—»ç»¼åˆ","å˜‰å…´æ–°é—»ç»¼åˆ","æ¡ä¹¡æ–°é—»ç»¼åˆ","è¡¢å·æ–°é—»ç»¼åˆ","è¡¢å·å…¬å…±","æµ™æ±ŸBesTV-1","æµ™æ±ŸBesTV-2","æµ™æ±ŸBesTV-3","æµ™æ±Ÿä¹‹å£°å¹¿æ’­","æµ™æ±Ÿæ–°é—»å¹¿æ’­","æµ™æ±Ÿç»æµå¹¿æ’­","æµ™æ±ŸéŸ³ä¹è°ƒé¢‘","æµ™æ±Ÿäº¤é€šä¹‹å£°","æµ™æ±Ÿæ—…æ¸¸ä¹‹å£°","æµ™æ±ŸåŸå¸‚ä¹‹å£°","æµ™æ±Ÿæ°‘ç”Ÿèµ„è®¯å¹¿æ’­"
],
"æ¹–åŒ—é¢‘é“":[  
"æ¹–åŒ—å…¬å…±","æ¹–åŒ—ç»¼åˆ","æ¹–åŒ—ç»è§†","æ¹–åŒ—å½±è§†","æ¹–åŒ—ç”Ÿæ´»","æ¹–åŒ—æ•™è‚²","æ¹–åŒ—å„ä¸Š","æ­¦æ±‰æ–°é—»ç»¼åˆ","æ­¦æ±‰ç”µè§†å‰§","æ­¦æ±‰æ•™è‚²","æ­¦æ±‰ç§‘æŠ€ç”Ÿæ´»","æ­¦æ±‰æ–‡ä½“","è”¡ç”¸æ–°é—»ç»¼åˆ","é˜³æ–°ç»¼åˆ","æˆ¿å¿ç»¼åˆ","ä¸¹æ±Ÿå£æ–°é—»é¢‘é“","é€šåŸæ–°é—»ç»¼åˆ","è¥„é˜³ç»¼åˆ","è¥„é˜³ç»æµ","è¥„é˜³å…¬å…±","å—æ¼³ç»¼åˆ","æ£é˜³ç»¼åˆ","è€æ²³å£ç»¼åˆ","è°·åŸç»¼åˆ","å®œæ˜Œç»¼åˆ","å®œæ˜Œæ—…æ¸¸ç”Ÿæ´»","å·´ä¸œæ–°é—»","å½“é˜³ç”µè§†å°","äº”å³°TV","è¿œå®‰èåª’","å¤·é™µç»¼åˆ","ç§­å½’èåª’","ææ±Ÿç»¼åˆ","é•¿é˜³ç»¼åˆ","å…´å±±ç»¼åˆ","é»„çŸ³ç»¼åˆ","é»„çŸ³éƒ½å¸‚","å­æ„Ÿç»¼åˆ","å­æ˜Œç»¼åˆ","äº‘æ¢¦ç»¼åˆ","åº”åŸç»¼åˆ","æ±‰å·ç»¼åˆ","å¤§æ‚Ÿç»¼åˆ","å¤©é—¨ç»¼åˆ","ä»™æ¡ƒç»¼åˆ","è†å·å…¬å…±","è†å·ç»¼åˆ","è†å·å„ä¸Š","æ±Ÿé™µç»¼åˆ","å…¬å®‰ç»¼åˆ","ç›‘åˆ©ç»¼åˆ","æ¾æ»‹ç»¼åˆ","æ´ªæ¹–ç»¼åˆ","çŸ³é¦–ç»¼åˆ","æ¹–åŒ—ä¹å±å¯¼è§†"    
],
"æµ·å—é¢‘é“":[
"æµ·å—å«è§†","ä¸‰æ²™å«è§†","æµ·å—è‡ªè´¸","æµ·å—æ–°é—»","æµ·å—æ–‡æ—…","æµ·å—å°‘å„¿","æµ·å—å…¬å…±","æµ·å£-1","æµ·å£-2","æµ·å£-3","ä¸‰äºš-1","å„‹å·","æ–‡æ˜Œ","ç™½æ²™","æ˜Œæ±Ÿ","äº”æŒ‡å±±","æ¾„è¿ˆ","ä¿äº­","é™µæ°´","ä¸‡å®","ä¸´é«˜","å±¯æ˜Œ","ç¼æµ·","å®šå®‰","ä¸œæ–¹","ç¼ä¸­","ä¹ä¸œ"    
],
"æ²³å—é¢‘é“":[
"æ²³å—éƒ½å¸‚","æ²³å—æ°‘ç”Ÿ","æ²³å—æ³•æ²»","æ²³å—æ–°é—»","æ²³å—æ¬¢è…¾è´­ç‰©","æ²³å—å…¬å…±","æ²³å—ä¹¡æ‘","æ²³å—å›½é™…","æ²³å—æ–‡ç‰©å®åº“","æ¢¨å›­é¢‘é“","æ²³å—æ­¦æœ¯ä¸–ç•Œ","æ²³å—ç”µè§†å‰§","å¥åº·ä¸­åŸ","è®¸æ˜Œç»¼åˆ","è®¸æ˜Œå…¬å…±","è®¸æ˜Œå†œä¸šç§‘æ•™","ç›å½©è®¸æ˜Œ","ç¦¹å·ç»¼åˆ","å›½å­¦é¢‘é“","æ²³å—ç§»åŠ¨ç”µè§†","æ²³å—å¯¼è§†","é©»é©¬åº—æ–°é—»ç»¼åˆ","é©»é©¬åº—ç§‘æ•™","é©»é©¬åº—å…¬å…±","è¥¿å¹³ç”µè§†å°","æ–°è”¡ç”µè§†å°","å¤§è±¡æ–°é—»","æ´›é˜³æ–‡æ—…","å—é˜³æ–°é—»ç»¼åˆ","å—é˜³å…¬å…±","å—é˜³ç§‘æ•™","ä¸‰é—¨å³¡æ–°é—»ç»¼åˆ","ä¸‰é—¨å³¡æ–‡æ—…","ä¿¡é˜³æ–°é—»ç»¼åˆ","ä¿¡é˜³æ–‡æ—…","å¹³é¡¶å±±æ–°é—»ç»¼åˆ","å¹³é¡¶å±±å…¬å…±","å¹³é¡¶å±±åŸå¸‚","ç„¦ä½œç»¼åˆ","ç„¦ä½œå…¬å…±"
],
"å±±è¥¿é¢‘é“":[
"å±±è¥¿å«è§†","å±±è¥¿å½±è§†","å±±è¥¿æ–‡ä½“ç”Ÿæ´»","å±±è¥¿ç¤¾ä¼šä¸æ³•æ²»","å±±è¥¿ç»æµä¸ç§‘æŠ€","é»„æ²³ç”µè§†å°","æ™‹ä¸­å…¬å…±","æ™‹ä¸­ç»¼åˆ","ç¨·å±±ç”µè§†å°","è¥¿å±±ç”µè§†å°","è¿åŸ-1","è¿åŸ-2","è¿åŸç›æ¹–é¢‘é“","é•¿æ²»é’¢é“ç”µè§†å°"
],
"æ±Ÿè‹é¢‘é“":[
"æ±Ÿè‹å¯¼è§†HD","æ±Ÿè‹åŸå¸‚HD","æ±Ÿè‹ç»¼è‰ºHD","æ±Ÿè‹ä½“è‚²HD","æ±Ÿè‹å½±è§†HD","æ±Ÿè‹å¡é€šHD","æ±Ÿè‹æ–°é—»HD","æ±Ÿè‹æ•™è‚²HD","æ±Ÿè‹å›½é™…HD","å—äº¬æ–°é—»","å—äº¬åå…«","å—äº¬ä¿¡æ¯","æ°´éŸµæ±Ÿè‹HD","å—äº¬å½±è§†","å—äº¬å¨±ä¹","å—äº¬å°‘å„¿","ç›±çœ™æ–°é—»HD","æ²›å¿æ–°é—»HD","æ³°å·æ–°é—»","å¾å·æ–°é—»","æ·®å®‰ç»¼åˆ","æ³—æ´ªç»¼åˆ","ä¸œæµ·æ–°é—»","æ±Ÿè‹åŸå¸‚","æ±Ÿè‹ç»¼è‰º","æ±Ÿè‹ä½“è‚²","æ±Ÿè‹å½±è§†","æ±Ÿè‹å¡é€š","æ±Ÿè‹å…¬å…±","æ±Ÿè‹å›½é™…","æ±Ÿè‹è´­ç‰©","æ±Ÿè‹æ•™è‚²","æ±Ÿè‹é“å¦†","å—äº¬ç§‘æ•™","å—äº¬ç”Ÿæ´»","å¾å·å…¬å…±","å¾å·å½±è§†","å¾å·ç»æµ","å¾å·ç»¼åˆ","æ·®å®‰å½±è§†","æ·®å®‰å…¬å…±","æ·®å®‰ç»¼åˆ","å®¿è±«ç»¼åˆ","æ³°å·ç»æµHD","æ³°å·å½±è§†HD","æ³—é˜³ç»¼åˆ","æ²­é˜³ç»¼åˆ","å®¿è¿å…¬å…±","æ±Ÿè‹å­¦ä¹ ","æ³—æ´ªç»¼åˆ","å¸¸å·å…¬å…±","å¸¸å·ç”Ÿæ´»","å¸¸å·éƒ½å¸‚","å¸¸å·æ–°é—»","ä¸œæµ·æ–°é—»","å®¿è¿ç»¼åˆ","å“æ°´ç»¼åˆ","é«˜æ·³ç»¼åˆ","æ–°æ²‚ç»¼åˆ","é‚³å·ç»¼åˆ","è¿äº‘æ–°é—»","è¿äº‘å…¬å…±","ç¢å®ç»¼åˆ","èµ£æ¦†ç»¼åˆ","è´¾æ±ªæ–°é—»","è‹å·ç”Ÿæ´»","æ±Ÿè‹4Kè·¨å¹´ç›´æ’­1","æ±Ÿè‹4Kè·¨å¹´ç›´æ’­2","æ±Ÿè‹ç”µç«ç›´æ’­HD","æ°´éŸµæ±Ÿè‹HD","æ±Ÿè‹ç›´æ’­å®¤-1HD","æ±Ÿè‹ç›´æ’­å®¤-2HD","æ±Ÿè‹ç›´æ’­å®¤-3HD","æ±Ÿè‹ç›´æ’­å®¤-4HD","æ±Ÿè‹ç›´æ’­å®¤-5HD","æ±Ÿè‹ç›´æ’­å®¤-6HD","æ±Ÿè‹ç›´æ’­å®¤-7HD","æ±Ÿè‹ç›´æ’­å®¤-8HD","æ±Ÿè‹ç›´æ’­å®¤-9HD","æ±Ÿè‹ç›´æ’­å®¤10HD","æ±Ÿè‹ç›´æ’­å®¤11HD"
],#ä»»æ„æ·»åŠ ï¼Œä¸ä»“åº“ä¸­rtp/çœä»½è¿è¥å•†.txtå†…é¢‘é“ä¸€è‡´å³å¯ï¼Œæˆ–åœ¨ä¸‹æ–¹é¢‘é“åæ˜ å°„ä¸­æ”¹å
}

# ===== æ˜ å°„ï¼ˆåˆ«å -> æ ‡å‡†åï¼‰ =====
CHANNEL_MAPPING = {

}#æ ¼å¼ä¸º"é¢‘é“åˆ†ç±»ä¸­çš„æ ‡å‡†å": ["rtp/ä¸­çš„åå­—"],

# ===============================
def get_run_count():
    if os.path.exists(COUNTER_FILE):
        try:
            return int(open(COUNTER_FILE, "r", encoding="utf-8").read().strip() or "0")
        except Exception:
            return 0
    return 0

def save_run_count(count):
    try:
        with open(COUNTER_FILE, "w", encoding="utf-8") as f:
            f.write(str(count))
    except Exception as e:
        print(f"âš ï¸ å†™è®¡æ•°æ–‡ä»¶å¤±è´¥ï¼š{e}")


# ===============================
def get_isp_from_api(data):
    isp_raw = (data.get("isp") or "").lower()

    if "telecom" in isp_raw or "ct" in isp_raw or "chinatelecom" in isp_raw:
        return "ç”µä¿¡"
    elif "unicom" in isp_raw or "cu" in isp_raw or "chinaunicom" in isp_raw:
        return "è”é€š"
    elif "mobile" in isp_raw or "cm" in isp_raw or "chinamobile" in isp_raw:
        return "ç§»åŠ¨"

    return "æœªçŸ¥"


def get_isp_by_regex(ip):
    if re.match(r"^(1[0-9]{2}|2[0-3]{2}|42|43|58|59|60|61|110|111|112|113|114|115|116|117|118|119|120|121|122|123|124|125|126|127|175|180|182|183|184|185|186|187|188|189|223)\.", ip):
        return "ç”µä¿¡"

    elif re.match(r"^(42|43|58|59|60|61|110|111|112|113|114|115|116|117|118|119|120|121|122|123|124|125|126|127|175|180|182|183|184|185|186|187|188|189|223)\.", ip):
        return "è”é€š"

    elif re.match(r"^(223|36|37|38|39|100|101|102|103|104|105|106|107|108|109|134|135|136|137|138|139|150|151|152|157|158|159|170|178|182|183|184|187|188|189)\.", ip):
        return "ç§»åŠ¨"

    return "æœªçŸ¥"


# ===============================
# ç¬¬ä¸€é˜¶æ®µ
def first_stage():
    os.makedirs(IP_DIR, exist_ok=True)
    all_ips = set()

    for url, filename in FOFA_URLS.items():
        print(f"ğŸ“¡ æ­£åœ¨çˆ¬å– {filename} ...")
        try:
            r = requests.get(url, headers=HEADERS, timeout=15)
            urls_all = re.findall(r'<a href="http://(.*?)"', r.text)
            all_ips.update(u.strip() for u in urls_all if u.strip())
        except Exception as e:
            print(f"âŒ çˆ¬å–å¤±è´¥ï¼š{e}")
        time.sleep(3)

    province_isp_dict = {}

    for ip_port in all_ips:
        try:
            host = ip_port.split(":")[0]

            is_ip = re.match(r"^\d{1,3}(\.\d{1,3}){3}$", host)

            if not is_ip:
                try:
                    resolved_ip = socket.gethostbyname(host)
                    print(f"ğŸŒ åŸŸåè§£ææˆåŠŸ: {host} â†’ {resolved_ip}")
                    ip = resolved_ip
                except Exception:
                    print(f"âŒ åŸŸåè§£æå¤±è´¥ï¼Œè·³è¿‡ï¼š{ip_port}")
                    continue
            else:
                ip = host

            res = requests.get(f"http://ip-api.com/json/{ip}?lang=zh-CN", timeout=10)
            data = res.json()

            province = data.get("regionName", "æœªçŸ¥").replace("çœ", "").replace("å¸‚", "")
            isp = get_isp_from_api(data)

            if isp == "æœªçŸ¥":
                isp = get_isp_by_regex(ip)

            if isp == "æœªçŸ¥":
                print(f"âš ï¸ æ— æ³•åˆ¤æ–­è¿è¥å•†ï¼Œè·³è¿‡ï¼š{ip_port}")
                continue

            fname = f"{province}{isp}.txt"
            province_isp_dict.setdefault(fname, set()).add(ip_port)

        except Exception as e:
            print(f"âš ï¸ è§£æ {ip_port} å‡ºé”™ï¼š{e}")
            continue

    count = get_run_count() + 1
    save_run_count(count)

    for filename, ip_set in province_isp_dict.items():
        path = os.path.join(IP_DIR, filename)
        try:
            with open(path, "a", encoding="utf-8") as f:
                for ip_port in sorted(ip_set):
                    f.write(ip_port + "\n")
            print(f"{path} å·²è¿½åŠ å†™å…¥ {len(ip_set)} ä¸ª IP")
        except Exception as e:
            print(f"âŒ å†™å…¥ {path} å¤±è´¥ï¼š{e}")

    print(f"âœ… ç¬¬ä¸€é˜¶æ®µå®Œæˆï¼Œå½“å‰è½®æ¬¡ï¼š{count}")
    return count


# ===============================
# ç¬¬äºŒé˜¶æ®µ
def second_stage():
    print("ğŸ”” ç¬¬äºŒé˜¶æ®µè§¦å‘ï¼šç”Ÿæˆ zubo.txt")
    if not os.path.exists(IP_DIR):
        print("âš ï¸ ip ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡ç¬¬äºŒé˜¶æ®µ")
        return

    combined_lines = []

    if not os.path.exists(RTP_DIR):
        print("âš ï¸ rtp ç›®å½•ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œç¬¬äºŒé˜¶æ®µç»„åˆï¼Œè·³è¿‡")
        return

    for ip_file in os.listdir(IP_DIR):
        if not ip_file.endswith(".txt"):
            continue

        ip_path = os.path.join(IP_DIR, ip_file)
        rtp_path = os.path.join(RTP_DIR, ip_file)

        if not os.path.exists(rtp_path):
            continue

        try:
            with open(ip_path, encoding="utf-8") as f1, open(rtp_path, encoding="utf-8") as f2:
                ip_lines = [x.strip() for x in f1 if x.strip()]
                rtp_lines = [x.strip() for x in f2 if x.strip()]
        except Exception as e:
            print(f"âš ï¸ æ–‡ä»¶è¯»å–å¤±è´¥ï¼š{e}")
            continue

        if not ip_lines or not rtp_lines:
            continue

        for ip_port in ip_lines:
            for rtp_line in rtp_lines:
                if "," not in rtp_line:
                    continue

                ch_name, rtp_url = rtp_line.split(",", 1)

                if "rtp://" in rtp_url:
                    part = rtp_url.split("rtp://", 1)[1]
                    combined_lines.append(f"{ch_name},http://{ip_port}/rtp/{part}")

                elif "udp://" in rtp_url:
                    part = rtp_url.split("udp://", 1)[1]
                    combined_lines.append(f"{ch_name},http://{ip_port}/udp/{part}")

    # å»é‡
    unique = {}
    for line in combined_lines:
        url_part = line.split(",", 1)[1]
        if url_part not in unique:
            unique[url_part] = line

    try:
        with open(ZUBO_FILE, "w", encoding="utf-8") as f:
            for line in unique.values():
                f.write(line + "\n")
        print(f"ğŸ¯ ç¬¬äºŒé˜¶æ®µå®Œæˆï¼Œå†™å…¥ {len(unique)} æ¡è®°å½•")
    except Exception as e:
        print(f"âŒ å†™æ–‡ä»¶å¤±è´¥ï¼š{e}")


# ===============================
# ç¬¬ä¸‰é˜¶æ®µ
def third_stage():
    print("ğŸ§© ç¬¬ä¸‰é˜¶æ®µï¼šå¤šçº¿ç¨‹æ£€æµ‹ä»£è¡¨é¢‘é“ç”Ÿæˆ IPTV.txt å¹¶å†™å›å¯ç”¨ IP åˆ° ip/ç›®å½•ï¼ˆè¦†ç›–ï¼‰")

    if not os.path.exists(ZUBO_FILE):
        print("âš ï¸ zubo.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡ç¬¬ä¸‰é˜¶æ®µ")
        return

    def check_stream(url, timeout=5):
        try:
            result = subprocess.run(
                ["ffprobe", "-v", "error", "-show_streams", "-i", url],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                timeout=timeout + 2
            )
            return b"codec_type" in result.stdout
        except Exception:
            return False

    # åˆ«åæ˜ å°„
    alias_map = {}
    for main_name, aliases in CHANNEL_MAPPING.items():
        for alias in aliases:
            alias_map[alias] = main_name

    # è¯»å–ç°æœ‰ ip æ–‡ä»¶ï¼Œå»ºç«‹ ip_port -> operator æ˜ å°„
    ip_info = {}
    if os.path.exists(IP_DIR):
        for fname in os.listdir(IP_DIR):
            if not fname.endswith(".txt"):
                continue
            province_operator = fname.replace(".txt", "")
            try:
                with open(os.path.join(IP_DIR, fname), encoding="utf-8") as f:
                    for line in f:
                        ip_port = line.strip()
                        if ip_port:
                            ip_info[ip_port] = province_operator
            except Exception as e:
                print(f"âš ï¸ è¯»å– {fname} å¤±è´¥ï¼š{e}")

    # è¯»å– zubo.txt å¹¶æŒ‰ ip:port åˆ†ç»„
    groups = {}
    with open(ZUBO_FILE, encoding="utf-8") as f:
        for line in f:
            if "," not in line:
                continue
            ch_name, url = line.strip().split(",", 1)
            ch_main = alias_map.get(ch_name, ch_name)
            m = re.match(r"http://(\d+\.\d+\.\d+\.\d+:\d+)/", url)
            if m:
                ip_port = m.group(1)
                groups.setdefault(ip_port, []).append((ch_main, url))

    # é€‰æ‹©ä»£è¡¨é¢‘é“å¹¶æ£€æµ‹
    def detect_ip(ip_port, entries):
        rep_channels = [u for c, u in entries if c == "CCTV-1ç»¼åˆ"]
        if not rep_channels and entries:
            rep_channels = [entries[0][1]]
        playable = any(check_stream(u) for u in rep_channels)
        return ip_port, playable

    print(f"ğŸš€ å¯åŠ¨å¤šçº¿ç¨‹æ£€æµ‹ï¼ˆå…± {len(groups)} ä¸ª IPï¼‰...")
    playable_ips = set()
    with concurrent.futures.ThreadPoolExecutor(max_workers=10) as executor:
        futures = {executor.submit(detect_ip, ip, chs): ip for ip, chs in groups.items()}
        for future in concurrent.futures.as_completed(futures):
            try:
                ip_port, ok = future.result()
            except Exception as e:
                print(f"âš ï¸ çº¿ç¨‹æ£€æµ‹è¿”å›å¼‚å¸¸ï¼š{e}")
                continue
            if ok:
                playable_ips.add(ip_port)

    print(f"âœ… æ£€æµ‹å®Œæˆï¼Œå¯æ’­æ”¾ IP å…± {len(playable_ips)} ä¸ª")

    valid_lines = []
    seen = set()
    operator_playable_ips = {}

    for ip_port in playable_ips:
        operator = ip_info.get(ip_port, "æœªçŸ¥")

        for c, u in groups.get(ip_port, []):
            key = f"{c},{u}"
            if key not in seen:
                seen.add(key)
                valid_lines.append(f"{c},{u}${operator}")

                operator_playable_ips.setdefault(operator, set()).add(ip_port)

    for operator, ip_set in operator_playable_ips.items():
        if operator == "æœªçŸ¥":
            target_file = os.path.join(IP_DIR, "æœªçŸ¥.txt")
        else:
            target_file = os.path.join(IP_DIR, operator + ".txt")
        try:
            os.makedirs(IP_DIR, exist_ok=True)
            with open(target_file, "w", encoding="utf-8") as wf:
                for ip in sorted(ip_set):
                    wf.write(ip + "\n")
            print(f"ğŸ“¥ è¦†ç›–å†™å…¥ {target_file}ï¼Œå…± {len(ip_set)} æ¡å¯ç”¨ IP")
        except Exception as e:
            print(f"âŒ å†™å› {target_file} å¤±è´¥ï¼š{e}")

    # å†™ IPTV.txtï¼ˆåŒ…å«æ›´æ–°æ—¶é—´ä¸åˆ†ç±»ï¼‰
    beijing_now = datetime.now(timezone(timedelta(hours=8))).strftime("%Y-%m-%d %H:%M:%S")

    try:
        with open(IPTV_FILE, "w", encoding="utf-8") as f:
            f.write(f"# æ›´æ–°æ—¶é—´: {beijing_now}ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰\n\n")

            for category, ch_list in CHANNEL_CATEGORIES.items():
                f.write(f"{category},#genre#\n")
                for ch in ch_list:
                    for line in valid_lines:
                        name = line.split(",", 1)[0]
                        if name == ch:
                            f.write(line + "\n")
                f.write("\n")
        print(f"ğŸ¯ IPTV.txt ç”Ÿæˆå®Œæˆï¼Œå…± {len(valid_lines)} æ¡é¢‘é“")
    except Exception as e:
        print(f"âŒ å†™ IPTV.txt å¤±è´¥ï¼š{e}")

# ===============================
# æ–‡ä»¶æ¨é€
def push_all_files():
    print("ğŸš€ æ¨é€æ‰€æœ‰æ›´æ–°æ–‡ä»¶åˆ° GitHub...")
    try:
        os.system('git config --global user.name "github-actions"')
        os.system('git config --global user.email "github-actions@users.noreply.github.com"')
    except Exception:
        pass

    os.system("git add è®¡æ•°.txt || true")
    os.system("git add ip/*.txt || true")
    os.system("git add IPTV.txt || true")
    os.system('git commit -m "è‡ªåŠ¨æ›´æ–°ï¼šè®¡æ•°ã€IPæ–‡ä»¶ã€IPTV.txt" || echo "âš ï¸ æ— éœ€æäº¤"')
    os.system("git push origin main || echo 'âš ï¸ æ¨é€å¤±è´¥'")

# ===============================
# ä¸»æ‰§è¡Œé€»è¾‘
if __name__ == "__main__":
    # ç¡®ä¿ç›®å½•å­˜åœ¨
    os.makedirs(IP_DIR, exist_ok=True)
    os.makedirs(RTP_DIR, exist_ok=True)

    run_count = first_stage()

    if run_count % 10 == 0:
        second_stage()
        third_stage()
    else:
        print("â„¹ï¸ æœ¬æ¬¡ä¸æ˜¯ 10 çš„å€æ•°ï¼Œè·³è¿‡ç¬¬äºŒã€ä¸‰é˜¶æ®µ")

    push_all_files()
